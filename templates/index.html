<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stellar Smart Harvest Bot - Advanced Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #2980b9;
      --light: #ecf0f1;
      --dark: #2c3e50;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      padding-top: 20px;
    }

    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
    }

    .status-running {
      background-color: var(--success);
      color: white;
    }

    .status-stopped {
      background-color: var(--danger);
      color: white;
    }

    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      background-color: var(--primary);
      color: white;
      border-radius: 10px 10px 0 0 !important;
      font-weight: bold;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--secondary);
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }

    .nav-tabs .nav-link.active {
      color: var(--primary);
      font-weight: bold;
      border-bottom: 3px solid var(--primary);
    }

    .nav-tabs .nav-link {
      color: #6c757d;
    }

    .log-entry {
      border-bottom: 1px solid #eee;
      padding: 5px 0;
      font-family: monospace;
    }

    .transaction-table {
      width: 100%;
    }

    .transaction-table th {
      background-color: var(--light);
    }

    .strategy-badge {
      padding: 3px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      margin-right: 5px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .config-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fas fa-robot"></i> Stellar Smart Harvest Bot
        </a>
        <div class="d-flex">
          <span class="status-badge me-3" id="statusDisplay">Status: {{ status }}</span>
          <div class="btn-group">
            <button id="startBtn" class="btn btn-success btn-sm" {% if not config_complete %}disabled{% endif %}>
              <i class="fas fa-play"></i> Start
            </button>
            <button id="stopBtn" class="btn btn-danger btn-sm">
              <i class="fas fa-stop"></i> Stop
            </button>
            <button id="refreshBtn" class="btn btn-info btn-sm">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>
    </nav>

    {% if not config_complete %}
    <div class="alert alert-warning">
      <h4><i class="fas fa-exclamation-triangle"></i> Configuration Required</h4>
      <p>Please complete the configuration below before starting the bot.</p>
    </div>
    {% endif %}

    <!-- Main Dashboard -->
    <div class="row">
      <!-- Left Column - Stats -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header">Portfolio Value</div>
          <div class="card-body text-center">
            <div class="stat-value">$<span id="portfolioValue">{{ portfolio_value | round(2) }}</span></div>
            <div class="stat-label">Total Portfolio Value</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Account Info</div>
          <div class="card-body">
            <p><strong>Public Key:</strong> <span id="publicKey">{{ public_key }}</span></p>
            <p><strong>Balance:</strong> <span id="accountBalance">{{ balance }}</span> XLM</p>
            <p><strong>Last Harvest:</strong> <span id="lastHarvest">
                {% if last_harvest_time %}
                {{ last_harvest_time | ctime }}
                {% else %}
                Never
                {% endif %}
              </span></p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Quick Actions</div>
          <div class="card-body">
            <button id="manualHarvestBtn" class="btn btn-primary w-100 mb-2" {% if not config_complete %}disabled{% endif %}>
              <i class="fas fa-hand-paper"></i> Manual Harvest
            </button>
            <button id="notificationsBtn" class="btn btn-outline-primary w-100 position-relative">
              <i class="fas fa-bell"></i> Notifications
              <span class="notification-badge">3</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Center Column - Main Content -->
      <div class="col-md-6">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="strategies-tab" data-bs-toggle="tab" data-bs-target="#strategies" type="button" role="tab">Strategies</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transactions</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">Configuration</button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content p-3 border border-top-0 rounded-bottom" id="mainTabsContent">
          <!-- Dashboard Tab -->
          <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
            <div class="row mb-4">
              <div class="col-md-12">
                <h4>Portfolio Performance</h4>
                <div class="chart-container">
                  <canvas id="performanceChart"></canvas>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <h4>Asset Prices</h4>
                <div class="list-group">
                  {% for asset, price in current_prices.items() %}
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    {{ asset }}
                    <span class="badge bg-primary rounded-pill">${{ price | round(4) }}</span>
                  </div>
                  {% endfor %}
                </div>
              </div>
              <div class="col-md-6">
                <h4>Active Strategies</h4>
                <div class="list-group">
                  {% for asset, strategy in strategies.items() %}
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                      <span>{{ asset }}</span>
                      <span class="badge strategy-badge bg-info">{{ strategy }}</span>
                    </div>
                    <small class="text-muted">Threshold: ${{ config.threshold_price }}</small>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <!-- Strategies Tab -->
          <div class="tab-pane fade" id="strategies" role="tabpanel">
            <h4>Trading Strategies</h4>
            <p class="text-muted">Configure and backtest your trading strategies</p>

            <div class="row mb-4">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">Strategy Backtesting</div>
                  <div class="card-body">
                    <form id="backtestForm">
                      <div class="row">
                        <div class="col-md-4">
                          <div class="mb-3">
                            <label class="form-label">Asset</label>
                            <select class="form-select" name="asset">
                              {% for asset in config.assets %}
                              <option value="{{ asset.name }}">{{ asset.name }}</option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="mb-3">
                            <label class="form-label">Strategy</label>
                            <select class="form-select" name="strategy">
                              <option value="simple_threshold">Simple Threshold</option>
                              <option value="moving_average">Moving Average</option>
                              <option value="rsi">RSI</option>
                              <option value="volatility">Volatility</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="mb-3">
                            <label class="form-label">Period (Days)</label>
                            <input type="number" class="form-control" name="days" value="30" min="7" max="365">
                          </div>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-primary">Run Backtest</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <h5>Backtest Results</h5>
                <div id="backtestResults" class="alert alert-info">
                  Run a backtest to see results here.
                </div>
                <div class="chart-container">
                  <canvas id="backtestChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Transactions Tab -->
          <div class="tab-pane fade" id="transactions" role="tabpanel">
            <h4>Transaction History</h4>
            <p class="text-muted">Recent harvest transactions and activities</p>

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Asset</th>
                    <th>Action</th>
                    <th>Amount</th>
                    <th>Price</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="transactionTableBody">
                  {% for tx in transactions %}
                  <tr>
                    <td>{{ tx.timestamp }}</td>
                    <td>{{ tx.asset }}</td>
                    <td>{{ tx.action }}</td>
                    <td>{{ tx.amount }}</td>
                    <td>${{ tx.price }}</td>
                    <td>
                      {% if tx.status == 'SUCCESS' %}
                      <span class="badge bg-success">Success</span>
                      {% else %}
                      <span class="badge bg-danger">Failed</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Configuration Tab -->
          <div class="tab-pane fade" id="config" role="tabpanel">
            <h4>Bot Configuration</h4>
            <p class="text-muted">Configure your harvest bot settings and strategies</p>

            {% if not config_complete %}
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i> Please complete the configuration below to start the bot.
            </div>
            {% endif %}

            <form id="configForm">
              <div class="config-section">
                <h5>Network Settings</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Network</label>
                      <select class="form-select" id="network" name="network">
                        <option value="testnet" {% if config.network=='testnet' %}selected{% endif %}>Testnet</option>
                        <option value="public" {% if config.network=='public' %}selected{% endif %}>Mainnet</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Horizon URL</label>
                      <input type="text" class="form-control" id="horizon_url" name="horizon_url" value="{{ config.horizon_url }}">
                    </div>
                  </div>
                </div>
              </div>

              <div class="config-section">
                <h5>Assets & Strategies</h5>
                <div id="assetsContainer">
                  {% for asset in config.assets %}
                  <div class="asset-config mb-3 border p-3 rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6>Asset Configuration</h6>
                      <button type="button" class="btn btn-sm btn-danger remove-asset"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Asset Name</label>
                          <input type="text" class="form-control" name="assets[{{ loop.index0 }}][name]" value="{{ asset.name }}">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Contract ID</label>
                          <input type="text" class="form-control" name="assets[{{ loop.index0 }}][contract_id]" value="{{ asset.contract_id }}">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Allocation %</label>
                          <input type="number" class="form-control" name="assets[{{ loop.index0 }}][allocation]" value="{{ asset.allocation }}" step="0.01" min="0" max="1">
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Strategy</label>
                          <select class="form-select" name="assets[{{ loop.index0 }}][strategy]">
                            <option value="simple_threshold" {% if asset.strategy=='simple_threshold' %}selected{% endif %}>Simple Threshold</option>
                            <option value="moving_average" {% if asset.strategy=='moving_average' %}selected{% endif %}>Moving Average</option>
                            <option value="rsi" {% if asset.strategy=='rsi' %}selected{% endif %}>RSI</option>
                            <option value="volatility" {% if asset.strategy=='volatility' %}selected{% endif %}>Volatility</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Threshold Price</label>
                          <input type="number" class="form-control" name="assets[{{ loop.index0 }}][threshold_price]" value="{{ asset.threshold_price }}" step="0.01">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Max Volatility</label>
                          <input type="number" class="form-control" name="assets[{{ loop.index0 }}][max_volatility]" value="{{ asset.max_volatility | default(0.5) }}" step="0.01" min="0" max="2">
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <button type="button" id="addAssetBtn" class="btn btn-outline-primary mt-2">
                  <i class="fas fa-plus"></i> Add Asset
                </button>
              </div>

              <div class="config-section">
                <h5>Risk Management</h5>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Minimum Balance (XLM)</label>
                      <input type="number" class="form-control" id="min_balance" name="min_balance" value="{{ config.min_balance }}" step="0.1">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Slippage Tolerance (%)</label>
                      <input type="number" class="form-control" id="slippage_tolerance" name="slippage_tolerance" value="{{ config.slippage_tolerance }}" step="0.01" min="0" max="1">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">Max Retries</label>
                      <input type="number" class="form-control" id="max_retries" name="max_retries" value="{{ config.max_retries }}" min="1" max="10">
                    </div>
                  </div>
                </div>
              </div>

              <div class="config-section">
                <h5>Notifications</h5>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications" {% if config.email_notifications %}checked{% endif %}>
                  <label class="form-check-label" for="email_notifications">Email Notifications</label>
                </div>
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="telegram_notifications" name="telegram_notifications" {% if config.telegram_notifications %}checked{% endif %}>
                  <label class="form-check-label" for="telegram_notifications">Telegram Notifications</label>
                </div>
              </div>

              <div class="config-section">
                <h5>Schedule</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Check Interval (seconds)</label>
                      <input type="number" class="form-control" id="schedule_interval" name="schedule_interval" value="{{ config.schedule_interval }}" min="10">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Health Check Interval (seconds)</label>
                      <input type="number" class="form-control" id="health_check_interval" name="health_check_interval" value="{{ config.health_check_interval }}" min="60">
                    </div>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-primary btn-lg">Save Configuration</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Right Column - Logs and Notifications -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>System Logs</span>
            <button id="clearLogsBtn" class="btn btn-sm btn-outline-light">
              <i class="fas fa-trash"></i> Clear
            </button>
          </div>
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            <div id="logContent">
              <!-- Logs will be loaded here -->
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Performance Metrics</div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span>24h Yield:</span>
              <span class="text-success">+2.3%</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>7d Yield:</span>
              <span class="text-success">+8.7%</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>30d Yield:</span>
              <span class="text-success">+24.5%</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Total Yield:</span>
              <span class="text-success">+56.2%</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">System Health</div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span>API Connection:</span>
              <span class="text-success"><i class="fas fa-check-circle"></i> Healthy</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Price Feed:</span>
              <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Degraded</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Blockchain Sync:</span>
              <span class="text-success"><i class="fas fa-check-circle"></i> Synced</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Last Health Check:</span>
              <span>2 minutes ago</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize charts
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(performanceCtx, {
      type: 'line',
      data: {
        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
        datasets: [{
          label: 'Portfolio Value (USD)',
          data: [1000, 1025, 1050, 1030, 1075, 1100, 1120],
          borderColor: '#3498db',
          tension: 0.1,
          fill: true,
          backgroundColor: 'rgba(52, 152, 219, 0.1)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    const backtestCtx = document.getElementById('backtestChart').getContext('2d');
    const backtestChart = new Chart(backtestCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Equity Curve',
          data: [],
          borderColor: '#27ae60',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });

    // Update status display
    function updateStatus() {
      fetch('/api/status')
        .then(response => response.json())
        .then(data => {
          document.getElementById('statusDisplay').textContent = `Status: ${data.status}`;
          document.getElementById('statusDisplay').className = `status-badge status-${data.status}`;
          document.getElementById('portfolioValue').textContent = data.portfolio_value ? data.portfolio_value.toFixed(2) : '0.00';
          
          if (data.last_harvest) {
            const date = new Date(data.last_harvest * 1000);
            document.getElementById('lastHarvest').textContent = date.toLocaleString();
          }

          // Enable/disable buttons based on config completeness and status
          const startBtn = document.getElementById('startBtn');
          const manualBtn = document.getElementById('manualHarvestBtn');
          
          if (startBtn) {
            startBtn.disabled = !data.config_complete || data.status === 'running';
          }
          
          if (manualBtn) {
            manualBtn.disabled = !data.config_complete;
          }
        });
    }

    // Load logs
    function loadLogs() {
      fetch('/api/logs')
        .then(response => response.json())
        .then(data => {
          const logContent = document.getElementById('logContent');
          logContent.innerHTML = data.logs.map(log => 
            `<div class="log-entry">${log}</div>`
          ).join('');
          logContent.scrollTop = logContent.scrollHeight;
        });
    }

    // Load transactions
    function loadTransactions() {
      fetch('/api/transactions?limit=10')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('transactionTableBody');
          if (data.transactions && data.transactions.length > 0) {
            tbody.innerHTML = data.transactions.map(tx => `
              <tr>
                <td>${new Date(tx.timestamp).toLocaleString()}</td>
                <td>${tx.asset}</td>
                <td>${tx.action}</td>
                <td>${tx.amount}</td>
                <td>$${tx.price}</td>
                <td>
                  ${tx.status === 'SUCCESS' ? 
                    '<span class="badge bg-success">Success</span>' : 
                    '<span class="badge bg-danger">Failed</span>'}
                </td>
              </tr>
            `).join('');
          } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No transactions found</td></tr>';
          }
        });
    }

    // Start bot
    document.getElementById('startBtn').addEventListener('click', () => {
      fetch('/api/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          updateStatus();
        });
    });

    // Stop bot
    document.getElementById('stopBtn').addEventListener('click', () => {
      fetch('/api/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          updateStatus();
        });
    });

    // Manual harvest
    document.getElementById('manualHarvestBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to manually trigger a harvest?')) {
        fetch('/api/manual-harvest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ asset: 'KALE' }) })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            updateStatus();
            loadTransactions();
          });
      }
    });

    // Refresh data
    document.getElementById('refreshBtn').addEventListener('click', () => {
      updateStatus();
      loadLogs();
      loadTransactions();
    });

    // Clear logs
    document.getElementById('clearLogsBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear the logs?')) {
        // This would need a server endpoint to clear logs
        alert('Log clearing functionality would be implemented here');
      }
    });

    // Add asset configuration
    document.getElementById('addAssetBtn').addEventListener('click', () => {
      const assetsContainer = document.getElementById('assetsContainer');
      const index = assetsContainer.children.length;
      
      const newAsset = `
        <div class="asset-config mb-3 border p-3 rounded">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6>Asset Configuration</h6>
            <button type="button" class="btn btn-sm btn-danger remove-asset"><i class="fas fa-trash"></i></button>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Asset Name</label>
                <input type="text" class="form-control" name="assets[${index}][name]" value="KALE">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Contract ID</label>
                <input type="text" class="form-control" name="assets[${index}][contract_id]" value="CA3D5KRYM6CB7OWQ6TWYRR3Z4T7GNZLKERYNZGGA5SOAOPIFY6YQGAXE">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Allocation %</label>
                <input type="number" class="form-control" name="assets[${index}][allocation]" value="0.5" step="0.01" min="0" max="1">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Strategy</label>
                <select class="form-select" name="assets[${index}][strategy]">
                  <option value="simple_threshold">Simple Threshold</option>
                  <option value="moving_average">Moving Average</option>
                  <option value="rsi">RSI</option>
                  <option value="volatility">Volatility</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Threshold Price</label>
                <input type="number" class="form-control" name="assets[${index}][threshold_price]" value="1.05" step="0.01">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Max Volatility</label>
                <input type="number" class="form-control" name="assets[${index}][max_volatility]" value="0.5" step="0.01" min="0" max="2">
              </div>
            </div>
          </div>
        </div>
      `;
      
      assetsContainer.insertAdjacentHTML('beforeend', newAsset);
      
      // Add event listener to the new remove button
      const removeButtons = document.querySelectorAll('.remove-asset');
      removeButtons[removeButtons.length - 1].addEventListener('click', function() {
        this.closest('.asset-config').remove();
      });
    });

    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-asset').forEach(button => {
      button.addEventListener('click', function() {
        this.closest('.asset-config').remove();
      });
    });

    // Backtest form submission
    document.getElementById('backtestForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const backtestData = {
        asset: formData.get('asset'),
        strategy: formData.get('strategy'),
        days: parseInt(formData.get('days'))
      };
      
      fetch('/api/backtest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(backtestData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const result = data.result;
          document.getElementById('backtestResults').innerHTML = `
            <strong>Backtest Results:</strong><br>
            Final Value: $${result.final_value.toFixed(2)}<br>
            Total Return: ${result.total_return.toFixed(2)}%<br>
            Number of Trades: ${result.signals.filter(s => s !== 'HOLD').length}
          `;
          
          // Update chart
          backtestChart.data.labels = Array.from({length: result.equity_curve.length}, (_, i) => `Day ${i+1}`);
          backtestChart.data.datasets[0].data = result.equity_curve;
          backtestChart.update();
        } else {
          document.getElementById('backtestResults').innerHTML = `
            <strong>Error:</strong> ${data.message}
          `;
        }
      });
    });

    // Save configuration
    document.getElementById('configForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const config = {};
      
      // Process form data
      for (let [key, value] of formData.entries()) {
        if (key.startsWith('assets[')) {
          // This is an asset configuration
          const match = key.match(/assets\[(\d+)\]\[(\w+)\]/);
          if (match) {
            const index = parseInt(match[1]);
            const property = match[2];
            
            if (!config.assets) config.assets = [];
            if (!config.assets[index]) config.assets[index] = {};
            
            // Convert numeric values
            if (['allocation', 'threshold_price', 'max_volatility'].includes(property)) {
              config.assets[index][property] = parseFloat(value);
            } else {
              config.assets[index][property] = value;
            }
          }
        } else {
          // Regular configuration value
          if (['min_balance', 'slippage_tolerance', 'max_retries', 'schedule_interval', 'health_check_interval'].includes(key)) {
            config[key] = parseFloat(value);
          } else if (['email_notifications', 'telegram_notifications'].includes(key)) {
            config[key] = value === 'on';
          } else {
            config[key] = value;
          }
        }
      }
      
      fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        if (data.config_complete) {
          // Reload the page to update the interface
          window.location.reload();
        }
      });
    });

    // Update status and logs periodically
    setInterval(updateStatus, 5000);
    setInterval(loadLogs, 3000);
    setInterval(loadTransactions, 10000);

    // Initial load
    updateStatus();
    loadLogs();
    loadTransactions();
  </script>
</body>

</html>